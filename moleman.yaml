# Example workflow file for the moleman runner.
# Copy this file and customize it for your repo.
# Agent defaults live in ./agents.yaml.
version: 1

agents:
  codex_review:
    extends: codex
    outputSchema: "schemas/review.json"

  codex_rereview:
    extends: codex
    outputSchema: "schemas/review.json"

workflow:
  - type: agent
    name: write
    agent: codex
    input:
      from: input
    output:
      toNext: true

  - type: agent
    name: review
    agent: codex_review
    input:
      prompt: "Review only the changes not yet committed (current git diff). Return JSON only. Original prompt: {{ .input.prompt }}"
    output:
      toNext: true

  - type: loop
    maxIters: 2
    until: "outputs.rereview_json.structured_output.must_fix_count == 0"
    body:
      - type: agent
        name: fix
        agent: codex
        session:
          resume: last
        input:
          from: review
        output:
          toNext: true

      - type: agent
        name: rereview
        agent: codex_rereview
        session:
          resume: last
        input:
          prompt: "Re-review the current git diff. Return JSON only. Context from last fix: {{ index .outputs \"fix\" }}"
        output:
          toNext: true
