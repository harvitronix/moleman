version: 1

agents:
  claude_review:
    extends: claude
    args:
      - "--output-format"
      - "json"
      - "--json-schema"
      - '{"type":"object","properties":{"must_fix_count":{"type":"integer"},"must_fix_items":{"type":"array","items":{"type":"string"}}},"required":["must_fix_count","must_fix_items"],"additionalProperties":false}'
      - "--allowedTools"
      - "Bash(git diff *),Bash(git status *),Read"

  claude_rereview:
    extends: claude
    args:
      - "--output-format"
      - "json"
      - "--json-schema"
      - '{"type":"object","properties":{"must_fix_count":{"type":"integer"},"must_fix_items":{"type":"array","items":{"type":"string"}}},"required":["must_fix_count","must_fix_items"],"additionalProperties":false}'
      - "--allowedTools"
      - "Bash(git diff *),Bash(git status *),Read"

workflow:
  - type: agent
    name: write
    agent: codex
    input:
      from: input
    output:
      toNext: true

  - type: loop
    maxIters: 3
    until: "outputs.rereview_json.structured_output.must_fix_count == 0"
    body:
      - type: agent
        name: review
        agent: claude_review
        input:
          prompt: "Review the current git diff and list must-fix issues."
        output:
          toNext: true

      - type: agent
        name: fix
        agent: codex
        session:
          resume: last
        input:
          from: review
        output:
          toNext: true

      - type: agent
        name: rereview
        agent: claude_rereview
        session:
          resume: last
        input:
          prompt: "Re-review the current git diff. Context from last fix: {{ index .outputs \"fix\" }}"
        output:
          toNext: true
